This is a slightly improved version of the parser shown at http://ru.stackoverflow.com/a/452045/10105
This one allows local function declarations, so the functions can be installed from interpreted code.